<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement de scolarité</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .btn-gradient {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            background: linear-gradient(45deg, #5245c9, #8479f2);
            color: white;
        }
        .custom-popup {
            background: linear-gradient(135deg, #2d3436, #636e72);
            border-radius: 20px;
        }
        .wizard-step {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>

<!-- Button to trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#wizardModal1">
    Ouvrir le formulaire de paiement
</button>

<!-- Modal -->
<div class="modal fade" id="wizardModal1" tabindex="-1" aria-labelledby="wizardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content custom-popup">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-white text-center w-100" id="wizardModalLabel">
                    ✨ Payer la scolarité
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body text-white">
                <!-- Step 1 -->
                <div class="wizard-step" id="step1">
                    <p>Choisissez une option :</p>
                    <div class="d-flex flex-column gap-3 mt-3 w-100">
                        <button type="button" class="btn btn-gradient rounded-pill py-2" onclick="nextStep(2)">
                            Payer sans créer un compte
                        </button>
                        <button type="button" class="btn btn-gradient rounded-pill py-2" onclick="openWizard2()">
                            Se connecter / Créer un compte
                        </button>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="wizard-step d-none" id="step2">
                    <p>Entrez le matricule de l'apprenant :</p>
                    <form id="matriculeForm">
                        <div class="mb-3">
                            <label for="matriculeInput" class="form-label text-light">Matricule</label>
                            <input type="text" class="form-control rounded-pill" id="matriculeInput" name="matricule" placeholder="Ex : MBJ25" required>
                            <div id="matriculeError" class="text-danger mt-2 d-none">Matricule non trouvé</div>
                        </div>
                    </form>
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-light rounded-pill px-4" onclick="prevStep(1)"> Retour </button>
                        <button type="button" class="btn btn-gradient rounded-pill px-4" id="rechercherBtn" onclick="rechercherMatricule()">
                            <span id="rechercherText">Suivant</span>
                            <span id="rechercherSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="wizard-step d-none" id="step3">
                    <p>Vérifiez les informations de l'apprenant :</p>
                    <div class="d-flex flex-column gap-2">
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label class="form-label text-light mb-0" style="width: 120px;">Matricule</label>
                            <input type="text" class="form-control rounded-pill flex-fill bg-light" id="displayMatricule" readonly>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label class="form-label text-light mb-0" style="width: 120px;">Nom & Prénoms</label>
                            <input type="text" class="form-control rounded-pill flex-fill bg-light" id="displayNomPrenom" readonly>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label class="form-label text-light mb-0" style="width: 120px;">École</label>
                            <input type="text" class="form-control rounded-pill flex-fill bg-light" id="displayEcole" readonly>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label class="form-label text-light mb-0" style="width: 120px;">Niveau</label>
                            <input type="text" class="form-control rounded-pill flex-fill bg-light" id="displayNiveau" readonly>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label class="form-label text-light mb-0" style="width: 120px;">Scolarité mensuelle</label>
                            <input type="text" class="form-control rounded-pill flex-fill bg-light" id="displayScolarite" readonly>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-light rounded-pill px-4" onclick="prevStep(2)"> Retour </button>
                        <button type="button" class="btn btn-gradient rounded-pill px-4" onclick="nextStep(4)"> Valider </button>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="wizard-step d-none" id="step4">
                    <p>Confirmez votre paiement :</p>
                    <form>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label class="form-label text-light mb-0" style="width: 120px;">Montant à payer</label>
                            <input type="text" class="form-control rounded-pill flex-fill bg-light" id="displayMontant" readonly>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label class="form-label text-light mb-0" style="width: 120px;">Frais de service</label>
                            <input type="text" class="form-control rounded-pill flex-fill bg-light" id="displayFrais" readonly>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label for="mobileMoneyType" class="form-label text-light mb-0" style="width: 120px;">Type mobile money</label>
                            <select id="mobileMoneyType" class="form-control rounded-pill flex-fill">
                                <option value="">-- Sélectionnez --</option>
                                <option value="airtel">Airtel Money</option>
                                <option value="moov">Moov Money</option>
                            </select>
                        </div>
                        <div class="mb-3 d-flex align-items-center gap-3">
                            <label for="telephoneInput" class="form-label text-light mb-0" style="width: 120px;">Numéro de téléphone</label>
                            <input type="text" class="form-control rounded-pill flex-fill" id="telephoneInput" placeholder="074273811">
                        </div>
                    </form>
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-light rounded-pill px-4" onclick="prevStep(3)"> Retour </button>
                        <button type="button" class="btn btn-gradient rounded-pill px-4" onclick="nextStep(5)"> Valider </button>
                    </div>
                </div>

                <!-- Step 5 -->
                <div class="wizard-step d-none" id="step5">
                    <div class="text-center">
                        <h5 class="fw-bold text-success">✅ Paiement réussi !</h5>
                        <p class="mt-3">Votre paiement a été effectué avec succès. Un reçu vous a été envoyé par SMS.</p>
                    </div>
                    <div class="d-flex justify-content-center mt-4">
                        <button type="button" class="btn btn-gradient rounded-pill px-4" data-bs-dismiss="modal">Terminer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Fonction pour rechercher le matricule
function rechercherMatricule() {
    const matricule = document.getElementById('matriculeInput').value;
    const errorDiv = document.getElementById('matriculeError');
    const rechercherBtn = document.getElementById('rechercherBtn');
    const rechercherText = document.getElementById('rechercherText');
    const rechercherSpinner = document.getElementById('rechercherSpinner');

    if (!matricule) {
        errorDiv.textContent = 'Veuillez saisir un matricule';
        errorDiv.classList.remove('d-none');
        return;
    }

    // Afficher le spinner de chargement
    rechercherText.classList.add('d-none');
    rechercherSpinner.classList.remove('d-none');
    rechercherBtn.disabled = true;

    // Envoyer la requête AJAX au serveur
    fetch('/rechercher-matricule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ matricule: matricule })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur réseau');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Remplir les champs avec les données reçues
            document.getElementById('displayMatricule').value = data.apprenant.matricule;
            document.getElementById('displayNomPrenom').value = data.apprenant.nom + ' ' + data.apprenant.prenom;
            document.getElementById('displayEcole').value = data.apprenant.etablissement;
            document.getElementById('displayNiveau').value = data.apprenant.niveau;
            document.getElementById('displayScolarite').value = data.apprenant.montant_scolarite + ' FCFA';
            document.getElementById('displayMontant').value = data.apprenant.montant_scolarite + ' FCFA';
            document.getElementById('displayFrais').value = data.apprenant.frais + ' FCFA';

            // Cacher l'erreur et passer à l'étape suivante
            errorDiv.classList.add('d-none');
            nextStep(3);
        } else {
            errorDiv.textContent = data.message;
            errorDiv.classList.remove('d-none');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        errorDiv.textContent = 'Une erreur s\'est produite lors de la recherche';
        errorDiv.classList.remove('d-none');
    })
    .finally(() => {
        // Cacher le spinner de chargement
        rechercherText.classList.remove('d-none');
        rechercherSpinner.classList.add('d-none');
        rechercherBtn.disabled = false;
    });
}

// Fonctions pour la navigation entre les étapes
function nextStep(step) {
    document.querySelectorAll('.wizard-step').forEach(el => {
        el.classList.add('d-none');
    });
    document.getElementById('step' + step).classList.remove('d-none');
}

function prevStep(step) {
    document.querySelectorAll('.wizard-step').forEach(el => {
        el.classList.add('d-none');
    });
    document.getElementById('step' + step).classList.remove('d-none');
}

function openWizard2() {
    // Fermer ce modal et ouvrir le modal de connexion/création de compte
    const modal = bootstrap.Modal.getInstance(document.getElementById('wizardModal1'));
    modal.hide();

    // Supposons que vous ayez un modal avec l'ID wizardModal2 pour la connexion
    // $('#wizardModal2').modal('show');
    alert("Ouverture du formulaire de connexion...");
}

// Permettre la soumission du formulaire avec la touche Entrée
document.getElementById('matriculeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        rechercherMatricule();
    }
});
</script>
</body>
</html>
